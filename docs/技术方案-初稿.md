# ğŸš€ è½»é‡çº§æ–¹æ³•çº§ç«ç„°å›¾é‡‡é›†æ–¹æ¡ˆ (BSFC FlameGraph)

## 1. é¡¹ç›®æ€»ä½“æ¶æ„

é‡‡ç”¨ Maven å¤šæ¨¡å—ç»“æ„ç»„ç»‡ï¼Œç¡®ä¿ä¾èµ–æ¸…æ™°ã€ç‰ˆæœ¬ç»Ÿä¸€ã€‚

**é¡¹ç›®æ‹“æ‰‘ï¼š**
```text
bsfc-tech-flamegraph (Root / Parent)
â”œâ”€â”€ flamegraph-spring-boot-starter (æ ¸å¿ƒç»„ä»¶ï¼šè‡ªåŠ¨è£…é… + é‡‡é›†å¼•æ“ + UI)
â””â”€â”€ flamegraph-spring-boot-starter-demo (ç¤ºä¾‹å·¥ç¨‹ï¼šæ¨¡æ‹Ÿä¸šåŠ¡è´Ÿè½½)
```

**ç‰ˆæœ¬ä¿¡æ¯ï¼š**
*   **Group ID**: `cn.bsfc.tech.springboot`
*   **Version**: `1.0.0-SNAPSHOT`
*   **Spring Boot**: `2.7.x` (å…¼å®¹ 3.x)
*   **JDK**: 8+

---

## 2. æ¨¡å—ä¸€ï¼šçˆ¶å·¥ç¨‹ (bsfc-tech-flamegraph)

è´Ÿè´£ç»Ÿä¸€ä¾èµ–ç‰ˆæœ¬ç®¡ç†ï¼ˆBOMï¼‰å’Œæ„å»ºé…ç½®ã€‚

**`pom.xml`**:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>cn.bsfc.tech.springboot</groupId>
    <artifactId>bsfc-tech-flamegraph</artifactId>
    <version>1.0.0-SNAPSHOT</version>
    <packaging>pom</packaging>

    <modules>
        <module>flamegraph-spring-boot-starter</module>
        <module>flamegraph-spring-boot-starter-demo</module>
    </modules>

    <properties>
        <java.version>1.8</java.version>
        <spring-boot.version>2.7.18</spring-boot.version>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    </properties>

    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-dependencies</artifactId>
                <version>${spring-boot.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <build>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.8.1</version>
                <configuration>
                    <source>${java.version}</source>
                    <target>${java.version}</target>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>
```

---

## 3. æ¨¡å—äºŒï¼šæ ¸å¿ƒ Starter (flamegraph-spring-boot-starter)

æ­¤æ¨¡å—åŒ…å«æ‰€æœ‰é‡‡é›†é€»è¾‘ã€è‡ªåŠ¨é…ç½®å’ŒåµŒå…¥å¼å‰ç«¯èµ„æºã€‚

### 3.1 ä¾èµ–é…ç½® (`pom.xml`)
```xml
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>cn.bsfc.tech.springboot</groupId>
        <artifactId>bsfc-tech-flamegraph</artifactId>
        <version>1.0.0-SNAPSHOT</version>
    </parent>

    <artifactId>flamegraph-spring-boot-starter</artifactId>

    <dependencies>
        <!-- åŸºç¡€ Web æ”¯æŒ (Providedï¼Œç”±å®¿ä¸»åº”ç”¨æä¾›) -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
            <scope>provided</scope>
        </dependency>
        <!-- é…ç½®æ–‡ä»¶æç¤º -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-configuration-processor</artifactId>
            <optional>true</optional>
        </dependency>
    </dependencies>
</project>
```

### 3.2 Java æ ¸å¿ƒä»£ç 

**åŒ…ç»“æ„**: `cn.bsfc.tech.springboot.flamegraph`

#### 1. é…ç½®å±æ€§ç±» (`FlameGraphProperties.java`)
```java
package cn.bsfc.tech.springboot.flamegraph;

import org.springframework.boot.context.properties.ConfigurationProperties;

@ConfigurationProperties(prefix = "flamegraph")
public class FlameGraphProperties {
    /** å¼€å…³ */
    private boolean enabled = true;
    /** é‡‡æ ·é—´éš”(ms)ï¼Œå»ºè®® >= 20ms */
    private long sampleInterval = 50;
    /** å †æ ˆæœ€å¤§æ·±åº¦ */
    private int maxDepth = 100;
    /** å†…å­˜ä¿æŠ¤ï¼šæœ€å¤§å…è®¸å­˜å‚¨çš„å †æ ˆè·¯å¾„æ•°é‡ */
    private int maxStoredStacks = 10000;

    // Getters and Setters omitted
    public boolean isEnabled() { return enabled; }
    public void setEnabled(boolean enabled) { this.enabled = enabled; }
    public long getSampleInterval() { return sampleInterval; }
    public void setSampleInterval(long sampleInterval) { this.sampleInterval = sampleInterval; }
    public int getMaxDepth() { return maxDepth; }
    public void setMaxDepth(int maxDepth) { this.maxDepth = maxDepth; }
    public int getMaxStoredStacks() { return maxStoredStacks; }
    public void setMaxStoredStacks(int maxStoredStacks) { this.maxStoredStacks = maxStoredStacks; }
}
```

#### 2. æ ¸å¿ƒé‡‡æ ·æœåŠ¡ (`FlameGraphService.java`)
åŒ…å«é‡‡é›†é€»è¾‘ï¼ˆExecutorï¼‰å’Œå­˜å‚¨é€»è¾‘ï¼ˆConcurrentHashMapï¼‰ã€‚

```java
package cn.bsfc.tech.springboot.flamegraph.core;

import tech.bsfc.springboot.flamegraph.FlameGraphProperties;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.lang.management.ManagementFactory;
import java.lang.management.ThreadInfo;
import java.lang.management.ThreadMXBean;
import java.util.Map;
import java.util.concurrent.*;
import java.util.concurrent.atomic.LongAdder;

public class FlameGraphService {
    private static final Logger log = LoggerFactory.getLogger(FlameGraphService.class);
    private static final String SAMPLER_THREAD_NAME = "bsfc-flamegraph-sampler";

    private final FlameGraphProperties properties;
    private final ConcurrentHashMap<String, LongAdder> stackRepository = new ConcurrentHashMap<>();
    private final ThreadMXBean threadMXBean = ManagementFactory.getThreadMXBean();
    private ScheduledExecutorService executor;

    public FlameGraphService(FlameGraphProperties properties) {
        this.properties = properties;
    }

    public synchronized void start() {
        if (!properties.isEnabled() || executor != null) return;

        executor = Executors.newSingleThreadScheduledExecutor(r -> {
            Thread t = new Thread(r, SAMPLER_THREAD_NAME);
            t.setDaemon(true); // å®ˆæŠ¤çº¿ç¨‹ï¼Œä¸é˜»æ­¢JVMå…³é—­
            return t;
        });

        executor.scheduleAtFixedRate(this::sample, 
                1000, properties.getSampleInterval(), TimeUnit.MILLISECONDS);
        
        log.info("BSFC FlameGraph sampler started. Interval: {}ms", properties.getSampleInterval());
    }

    private void sample() {
        try {
            // è·å–æ‰€æœ‰çº¿ç¨‹ï¼Œfalse, false é¿å…è·å–Monitor/Synchronizeré€ æˆçš„é¢å¤–å¼€é”€
            ThreadInfo[] threads = threadMXBean.dumpAllThreads(false, false);

            for (ThreadInfo t : threads) {
                // 1. çŠ¶æ€è¿‡æ»¤ï¼šåªå…³æ³¨ RUNNABLE
                if (t.getThreadState() != Thread.State.RUNNABLE) continue;
                // 2. è‡ªæˆ‘æ’é™¤
                if (SAMPLER_THREAD_NAME.equals(t.getThreadName())) continue;

                StackTraceElement[] stack = t.getStackTrace();
                if (stack == null || stack.length == 0) continue;

                // 3. æ ¼å¼è½¬æ¢ï¼šStackElement[] -> Collapse String
                String signature = collapseStack(stack);

                // 4. å†…å­˜ä¿æŠ¤ä¸å†™å…¥
                if (stackRepository.size() >= properties.getMaxStoredStacks() 
                        && !stackRepository.containsKey(signature)) {
                    continue; // è¶…è¿‡é˜ˆå€¼ï¼Œä¸¢å¼ƒæ–°è·¯å¾„
                }
                
                stackRepository.computeIfAbsent(signature, k -> new LongAdder()).increment();
            }
        } catch (Exception e) {
            // åæ‰å¼‚å¸¸ï¼Œç¡®ä¿ä¸å½±å“ä¸»ä¸šåŠ¡
        }
    }

    /**
     * å°†å †æ ˆè½¬æ¢ä¸º collapse æ ¼å¼ï¼š Class.method;Class.method
     * æ³¨æ„ï¼šJDK è¿”å›æ˜¯ æ ˆé¡¶(method)->æ ˆåº•(main)ï¼Œç«ç„°å›¾éœ€è¦ æ ˆåº•->æ ˆé¡¶
     */
    private String collapseStack(StackTraceElement[] stack) {
        StringBuilder sb = new StringBuilder();
        int depth = Math.min(stack.length, properties.getMaxDepth());
        
        // å€’åºéå†
        for (int i = depth - 1; i >= 0; i--) {
            StackTraceElement e = stack[i];
            sb.append(e.getClassName()).append(".").append(e.getMethodName());
            if (i > 0) sb.append(";");
        }
        return sb.toString();
    }

    public String dumpData() {
        StringBuilder sb = new StringBuilder();
        for (Map.Entry<String, LongAdder> entry : stackRepository.entrySet()) {
            sb.append(entry.getKey()).append(" ").append(entry.getValue().sum()).append("\n");
        }
        return sb.toString();
    }

    public void reset() {
        stackRepository.clear();
    }
}
```

#### 3. Web æ¥å£ (`FlameGraphController.java`)
```java
package cn.bsfc.tech.springboot.flamegraph.web;

import core.tech.bsfc.springboot.flamegraph.FlameGraphService;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/v1/flamegraph")
public class FlameGraphController {
    
    private final FlameGraphService service;

    public FlameGraphController(FlameGraphService service) {
        this.service = service;
    }

    @GetMapping(produces = "text/plain")
    public String getData() {
        return service.dumpData();
    }

    @PostMapping("/reset")
    public String reset() {
        service.reset();
        return "ok";
    }
}
```

#### 4. è‡ªåŠ¨è£…é… (`FlameGraphAutoConfiguration.java`)
```java
package cn.bsfc.tech.springboot.flamegraph;

import core.tech.bsfc.springboot.flamegraph.FlameGraphService;
import web.tech.bsfc.springboot.flamegraph.FlameGraphController;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
@EnableConfigurationProperties(FlameGraphProperties.class)
@ConditionalOnProperty(prefix = "flamegraph", name = "enabled", havingValue = "true", matchIfMissing = true)
public class FlameGraphAutoConfiguration {

    @Bean(initMethod = "start")
    public FlameGraphService flameGraphService(FlameGraphProperties properties) {
        return new FlameGraphService(properties);
    }

    @Bean
    public FlameGraphController flameGraphController(FlameGraphService service) {
        return new FlameGraphController(service);
    }
}
```

#### 5. æ³¨å†Œ Spring Boot Starter
åœ¨ `src/main/resources/META-INF/spring.factories` (Spring Boot 2.x) ä¸­æ·»åŠ ï¼š
```properties
org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
tech.bsfc.springboot.flamegraph.FlameGraphAutoConfiguration
```
*(å¦‚æœæ˜¯ Spring Boot 3.xï¼Œåˆ™åˆ›å»º `META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports` æ–‡ä»¶å¹¶å¡«å…¥ç±»å…¨å)*

### 3.3 å‰ç«¯èµ„æº

è·¯å¾„ï¼š`src/main/resources/META-INF/resources/flamegraph/index.html`

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>BSFC Flame Graph</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/d3-flame-graph@4.1.3/dist/d3-flamegraph.css">
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .header { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
        button { padding: 8px 16px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background: #0056b3; }
        #chart { border: 1px solid #eee; padding: 10px; }
    </style>
</head>
<body>
    <div class="header">
        <h2>ğŸ”¥ Method-Level Flame Graph</h2>
        <button onclick="loadData()">Refresh</button>
        <button onclick="resetData()" style="background: #dc3545;">Reset</button>
        <span id="status" style="color: #666; font-size: 0.9em;"></span>
    </div>
    <div id="chart"></div>
    <div id="details"></div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-flame-graph@4.1.3/dist/d3-flamegraph.min.js"></script>
    <script>
        // å°†åç«¯è¿”å›çš„ collapse æ–‡æœ¬è½¬ä¸º D3 éœ€è¦çš„ JSON æ ‘
        function convertToHierarchy(text) {
            const root = { name: "root", value: 0, children: [] };
            if (!text || !text.trim()) return root;

            text.trim().split('\n').forEach(line => {
                const lastSpace = line.lastIndexOf(' ');
                if (lastSpace === -1) return;
                
                const stackParts = line.substring(0, lastSpace).split(';');
                const count = parseInt(line.substring(lastSpace + 1));
                
                let currentNode = root;
                currentNode.value += count;

                stackParts.forEach(part => {
                    let child = currentNode.children.find(c => c.name === part);
                    if (!child) {
                        child = { name: part, value: 0, children: [] };
                        currentNode.children.push(child);
                    }
                    child.value += count;
                    currentNode = child;
                });
            });
            return root;
        }

        const chart = d3.flamegraph().width(window.innerWidth - 60).cellHeight(18).transitionDuration(500);

        function loadData() {
            document.getElementById("status").innerText = "Loading...";
            fetch('/api/v1/flamegraph')
                .then(r => r.text())
                .then(text => {
                    const json = convertToHierarchy(text);
                    d3.select("#chart").datum(json).call(chart);
                    document.getElementById("status").innerText = `Updated at ${new Date().toLocaleTimeString()}. Samples: ${json.value}`;
                });
        }

        function resetData() {
            fetch('/api/v1/flamegraph/reset', { method: 'POST' })
                .then(() => {
                    loadData(); // ç«‹å³åˆ·æ–°æ¸…ç©º
                    document.getElementById("status").innerText = "Reset successfully. Recording new samples...";
                });
        }

        loadData(); // åˆå§‹åŒ–åŠ è½½
    </script>
</body>
</html>
```

---

## 4. æ¨¡å—ä¸‰ï¼šDemo æ¼”ç¤ºå·¥ç¨‹ (flamegraph-spring-boot-starter-demo)

ç”¨äºéªŒè¯ Starter æ˜¯å¦ç”Ÿæ•ˆï¼Œå¹¶æä¾›ä¸€ä¸ªæ¨¡æ‹Ÿçš„é«˜è´Ÿè½½æ¥å£æ¥ç”Ÿæˆç«ç„°å›¾æ•°æ®ã€‚

### 4.1 ä¾èµ–é…ç½® (`pom.xml`)
```xml
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>cn.bsfc.tech.springboot</groupId>
        <artifactId>bsfc-tech-flamegraph</artifactId>
        <version>1.0.0-SNAPSHOT</version>
    </parent>

    <artifactId>flamegraph-spring-boot-starter-demo</artifactId>

    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <!-- å¼•å…¥è‡ªå®šä¹‰ Starter -->
        <dependency>
            <groupId>cn.bsfc.tech.springboot</groupId>
            <artifactId>flamegraph-spring-boot-starter</artifactId>
            <version>${project.version}</version>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>
</project>
```

### 4.2 æ¨¡æ‹Ÿåº”ç”¨ä»£ç 

**å¯åŠ¨ç±»**:
```java
package cn.bsfc.demo;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class DemoApplication {
    public static void main(String[] args) {
        SpringApplication.run(DemoApplication.class, args);
    }
}
```

**é…ç½® (`application.yml`)**:
```yaml
server:
  port: 8080

flamegraph:
  enabled: true
  sample-interval: 20 # æ¼”ç¤ºæ—¶è°ƒé«˜é¢‘ç‡ï¼Œä»¥ä¾¿å¿«é€Ÿçœ‹åˆ°æ•ˆæœ
```

**æ¨¡æ‹Ÿè´Ÿè½½æ¥å£ (`SimulationController.java`)**:
```java
package cn.bsfc.demo.controller;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;
import java.util.Random;

@RestController
public class SimulationController {

    // æ¨¡æ‹Ÿ CPU å¯†é›†å‹ä»»åŠ¡
    @GetMapping("/work")
    public String heavyWork() {
        long start = System.currentTimeMillis();
        // è¿è¡Œ 500ms çš„ç©ºå¾ªç¯è®¡ç®—
        while (System.currentTimeMillis() - start < 500) {
            Math.tan(new Random().nextDouble());
            subMethodA();
        }
        return "Work Done";
    }

    private void subMethodA() {
        if (new Random().nextInt(100) > 50) {
            subMethodB();
        }
    }

    private void subMethodB() {
        Math.sin(new Random().nextDouble());
    }
}
```

---

## 5. éªŒè¯ä¸è¿è¡Œæ­¥éª¤

1.  **æ„å»ºé¡¹ç›®**ï¼š
    åœ¨æ ¹ç›®å½• `bsfc-tech-flamegraph` ä¸‹æ‰§è¡Œï¼š
    ```bash
    mvn clean install
    ```

2.  **å¯åŠ¨ Demo**ï¼š
    è¿›å…¥ `flamegraph-spring-boot-starter-demo` ç›®å½•ï¼š
    ```bash
    mvn spring-boot:run
    ```

3.  **ç”Ÿæˆæµé‡**ï¼š
    ä¸ºäº†è®©ç«ç„°å›¾æœ‰æ•°æ®ï¼Œéœ€è¦æ¨¡æ‹Ÿè´Ÿè½½ã€‚åœ¨æµè§ˆå™¨ä¸æ–­åˆ·æ–°è®¿é—®ï¼š
    `http://localhost:8080/work`

4.  **æŸ¥çœ‹ç«ç„°å›¾**ï¼š
    è®¿é—® UI ç•Œé¢ï¼š
    `http://localhost:8080/flamegraph/index.html`

    *ä½ å°†çœ‹åˆ° `SimulationController.heavyWork` åŠå…¶å­æ–¹æ³• `subMethodA`, `subMethodB` å æ®äº†å¤§é‡çš„æ¨ªæ¡å®½åº¦ã€‚*

---

## 6. èµ„æ·±å·¥ç¨‹å¸ˆæ–¹æ¡ˆæ€»ç»“

1.  **å·¥ç¨‹åŒ–**ï¼šé€šè¿‡ Maven çˆ¶å­å·¥ç¨‹å®ç°äº† Starter ä¸ ä¸šåŠ¡ä»£ç çš„è§£è€¦ã€‚
2.  **å®‰å…¨æ€§**ï¼šä½¿ç”¨ `ConcurrentHashMap` å¤„ç†å¹¶å‘å†™å…¥ï¼Œ`LongAdder` ä¼˜åŒ–è®¡æ•°å™¨æ€§èƒ½ï¼›é€šè¿‡ `maxStoredStacks` é˜²æ­¢å†…å­˜æ³„æ¼ã€‚
3.  **æ€§èƒ½æƒè¡¡**ï¼š
    *   **ä¼˜ç‚¹**ï¼šçº¯ Java å®ç°ï¼Œè·¨å¹³å°ï¼Œæ— éœ€ Agentï¼Œæ— éœ€é‡å¯ JVM å³å¯ Attachï¼ˆåªè¦åº”ç”¨å¼•å…¥äº† Starterï¼‰ã€‚
    *   **ç¼ºç‚¹**ï¼š`ThreadMXBean.dumpAllThreads` ä¼šè§¦å‘ Global Safepointï¼Œé«˜é¢‘é‡‡æ ·ï¼ˆ<10msï¼‰ä¼šå½±å“ååé‡ã€‚
    *   **å»ºè®®**ï¼šä»…åœ¨å¼€å‘/æµ‹è¯•ç¯å¢ƒå¼€å¯ï¼Œæˆ–ç”Ÿäº§ç¯å¢ƒé…åˆ Actuator åŠ¨æ€å¼€å…³ä½¿ç”¨ã€‚
4.  **å¯è§†åŒ–**ï¼šåˆ©ç”¨ D3.js å°†åç«¯ç®€å•çš„æ–‡æœ¬æ•°æ®è½¬åŒ–ä¸ºä¸°å¯Œçš„äº¤äº’å¼å›¾è¡¨ï¼Œå®ç°â€œé›¶ä¾èµ–éƒ¨ç½²â€çš„æè‡´ä½“éªŒã€‚