<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Java Method Flame Graph</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://unpkg.com/d3-flame-graph@4.1.3/dist/d3-flamegraph.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/d3-flame-graph@4.1.3/dist/d3-flamegraph.css"/>
    <style>
        html, body {
            height: 100%; margin: 0; padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5; overflow: hidden;
            display: flex; flex-direction: column;
        }

        .header {
            background: white; padding: 10px 20px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1); z-index: 10;
            display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0; height: 50px;
        }

        .header-left { display: flex; align-items: center; gap: 15px; }
        .header-title h1 { margin: 0; font-size: 18px; color: #333; }

        .status-badge {
            font-size: 12px; padding: 3px 10px; border-radius: 12px;
            background: #eee; color: #666; display: flex; align-items: center; gap: 6px; transition: all 0.3s;
        }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; }
        .running .dot { background: #28a745; box-shadow: 0 0 5px #28a745; animation: pulse 1.5s infinite; }
        .running { background: #e6f4ea; color: #1e7e34; border: 1px solid #c3e6cb; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        .controls { display: flex; gap: 8px; align-items: center; }

        button {
            padding: 6px 12px; border: none; border-radius: 4px;
            cursor: pointer; font-size: 12px; font-weight: 600; color: white;
            transition: all 0.2s; display: flex; align-items: center; gap: 5px;
        }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button:active { transform: translateY(0); }

        .btn-start { background-color: #28a745; }
        .btn-stop  { background-color: #ffc107; color: #333; }
        .btn-primary { background-color: #007bff; }
        .btn-info { background-color: #17a2b8; }
        .btn-danger { background-color: #dc3545; }

        .main-content {
            flex: 1; padding: 10px; overflow: hidden;
            display: flex; flex-direction: column; position: relative;
        }
        .chart-wrapper {
            background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            flex: 1; overflow: hidden; /* å†…éƒ¨æ»šåŠ¨ç”± D3 å®¹å™¨å¤„ç† */
            position: relative; display: flex; flex-direction: column;
        }
        #chart { width: 100%; height: 100%; overflow: auto; }

        .overlay-msg {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; color: #666; display: none; pointer-events: none;
            background: rgba(255,255,255,0.9); padding: 20px; border-radius: 8px;
        }

        .footer {
            padding: 5px 20px; background: #fafafa; color: #888;
            font-size: 11px; text-align: right; flex-shrink: 0; border-top: 1px solid #e0e0e0;
        }
    </style>
</head>
<body>
<div class="header">
    <div class="header-left">
        <div class="header-title"><h1>ğŸ”¥ Java Flame Graph</h1></div>
        <div id="statusIndicator" class="status-badge">
            <div class="dot"></div>
            <span id="statusText">å·²åœæ­¢</span>
        </div>
    </div>
    <div class="controls">
        <button id="startBtn" class="btn-start">â–¶ å¯åŠ¨é‡‡æ ·</button>
        <button id="stopBtn" class="btn-stop" style="display:none;">â¸ åœæ­¢é‡‡æ ·</button>
        <div style="width:1px; height:20px; background:#ddd; margin:0 5px;"></div>
        <button id="copyBtn" class="btn-info">ğŸ“‹ å¤åˆ¶</button>
        <button id="refreshBtn" class="btn-primary">ğŸ”„ åˆ·æ–°</button>
        <button id="resetBtn" class="btn-danger">ğŸ—‘ï¸ æ¸…ç©º</button>
    </div>
</div>

<div class="main-content">
    <div class="chart-wrapper">
        <div id="chart"></div>

        <div id="loading" class="overlay-msg" style="color:#007bff;">
            <div style="font-size:20px; margin-bottom:10px;">â³</div>
            æ­£åœ¨æ‹‰å–æ•°æ®...
        </div>

        <div id="noData" class="overlay-msg">
            <div style="font-size:24px; margin-bottom:10px;">ğŸ“­</div>
            <div>æš‚æ— é‡‡æ ·æ•°æ®</div>
            <div style="font-size:12px; margin-top:5px; color:#999;">è¯·ç‚¹å‡»â€œå¯åŠ¨é‡‡æ ·â€å¹¶ç¡®ä¿åº”ç”¨æœ‰è´Ÿè½½(CPU/é”)</div>
        </div>

        <div id="errorMsg" class="overlay-msg" style="color:#dc3545; border:1px solid #f5c6cb;"></div>
    </div>
</div>

<div class="footer" id="statusBar">Ready</div>

<script>
    let flameChart = null;
    let flameGraphFactory = null;
    let currentRawData = "";
    let autoRefreshTimer = null;

    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(() => {
            if (typeof d3 === 'undefined') return showError('D3.js åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
            initLibrary();
            checkServerStatus(); // é¡µé¢åŠ è½½æ—¶åŒæ­¥æœåŠ¡å™¨çŠ¶æ€
        }, 300);

        document.getElementById('startBtn').onclick = () => toggleSampling(true);
        document.getElementById('stopBtn').onclick = () => toggleSampling(false);
        document.getElementById('refreshBtn').onclick = () => loadData(true);
        document.getElementById('resetBtn').onclick = resetData;
        document.getElementById('copyBtn').onclick = copyToClipboard;
    });

    // --- æ ¸å¿ƒåº“åˆå§‹åŒ– ---
    function initLibrary() {
        if (typeof flamegraph !== 'undefined') flameGraphFactory = flamegraph;
        else if (d3 && typeof d3.flamegraph !== 'undefined') flameGraphFactory = d3.flamegraph;
        else if (window.flamegraph && window.flamegraph.flamegraph) flameGraphFactory = window.flamegraph.flamegraph;

        if (!flameGraphFactory) return showError('d3-flame-graph åº“æœªæ‰¾åˆ°');

        try {
            // åˆå§‹åŒ–æ—¶ä¸è®¾ç½®å›ºå®šå®½åº¦ï¼Œè€Œåœ¨ render æ—¶åŠ¨æ€è®¡ç®—
            flameChart = flameGraphFactory()
                .cellHeight(18)
                .transitionDuration(500)
                .minFrameSize(2)
                .sort(true)
                .title("")
                .inverted(true); // ç«ç„°å›¾æ ¹éƒ¨åœ¨ä¸‹

            // çª—å£å˜åŒ–æ—¶é‡ç»˜
            window.addEventListener('resize', () => {
                if(currentRawData) renderChart(currentRawData);
            });
        } catch (e) { showError('å›¾è¡¨åˆå§‹åŒ–å¼‚å¸¸: ' + e.message); }
    }

    // --- çŠ¶æ€æ§åˆ¶ä¸è½®è¯¢ ---
    async function checkServerStatus() {
        try {
            const res = await fetch('/api/v1/flamegraph/status');
            const data = await res.json();
            updateUiState(data.sampling);
        } catch(e) { console.error("Status check error", e); }
    }

    async function toggleSampling(enable) {
        try {
            const endpoint = enable ? '/start' : '/stop';
            const res = await fetch(`/api/v1/flamegraph${endpoint}`, { method: 'POST' });
            if(res.ok) {
                updateUiState(enable);
                if(enable) loadData(false); // å¯åŠ¨æ—¶ç«‹å³åŠ è½½ä¸€æ¬¡
            }
        } catch(e) { alert("æ“ä½œå¤±è´¥: " + e.message); }
    }

    function updateUiState(isSampling) {
        const indicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');

        // æŒ‰é’®æ˜¾éš
        document.getElementById('startBtn').style.display = isSampling ? 'none' : 'flex';
        document.getElementById('stopBtn').style.display = isSampling ? 'flex' : 'none';

        if(isSampling) {
            indicator.classList.add('running');
            statusText.innerText = "æ­£åœ¨é‡‡æ · (æ¯3såˆ·æ–°)";
            // å¼€å¯è‡ªåŠ¨è½®è¯¢
            if(!autoRefreshTimer) {
                autoRefreshTimer = setInterval(() => loadData(false), 3000);
            }
        } else {
            indicator.classList.remove('running');
            statusText.innerText = "å·²åœæ­¢";
            // å…³é—­è‡ªåŠ¨è½®è¯¢
            if(autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
            }
        }
    }

    // --- æ•°æ®åŠ è½½ä¸æ¸²æŸ“ ---
    async function loadData(showLoading = true) {
        if(showLoading) setLoading(true);
        try {
            const response = await fetch('/api/v1/flamegraph');
            const textData = await response.text();
            currentRawData = textData;

            if(showLoading) setLoading(false);

            if (!textData || !textData.trim() || textData.trim().startsWith('#')) {
                if(showLoading) showNoData(true); // åªæœ‰æ‰‹åŠ¨åˆ·æ–°æ‰æ˜¾ç¤º"æ— æ•°æ®"é®ç½©ï¼Œé¿å…è‡ªåŠ¨åˆ·æ–°é—ªçƒ
                // å¦‚æœæ˜¯è‡ªåŠ¨åˆ·æ–°ä¸”æ— æ•°æ®ï¼Œä¿æŒå½“å‰ç•Œé¢æˆ–æ¸…ç©ºå›¾è¡¨
                if(!showLoading && document.getElementById('chart').innerHTML === "") showNoData(true);
                updateStatus("æš‚æ— æ•°æ®é‡‡æ ·...");
                return;
            }

            showNoData(false);
            renderChart(textData);
            updateStatus(`æ›´æ–°äº: ${new Date().toLocaleTimeString()} | æ ·æœ¬é‡: ${textData.split('\n').length}`);
        } catch (err) {
            if(showLoading) setLoading(false);
            console.error("Load failed", err);
        }
    }

    function renderChart(data) {
        const chartDiv = document.getElementById('chart');
        // æ¸…ç©ºå®¹å™¨
        chartDiv.innerHTML = '';

        const root = parseCollapsedData(data);
        if (root.children.length === 0) {
            showNoData(true);
            return;
        }

        // å…³é”®ä¿®å¤ï¼šæ¯æ¬¡æ¸²æŸ“å‰è·å–å½“å‰å®¹å™¨çš„å®é™…å®½åº¦
        const width = document.querySelector('.chart-wrapper').clientWidth;
        flameChart.width(width);

        d3.select("#chart").datum(root).call(flameChart);
    }

    function parseCollapsedData(data) {
        const root = { name: "root", value: 0, children: [] };
        const pathMap = new Map();
        pathMap.set("", root);

        data.trim().split('\n').forEach(line => {
            if(!line.trim()) return;
            const lastSpace = line.lastIndexOf(' ');
            if (lastSpace === -1) return;

            const stack = line.substring(0, lastSpace);
            const count = parseInt(line.substring(lastSpace + 1));
            if (isNaN(count)) return;

            const methods = stack.split(';');
            let currentPath = "";
            let currentNode = root;
            root.value += count;

            methods.forEach(method => {
                const newPath = currentPath + (currentPath ? ";" : "") + method;
                if (!pathMap.has(newPath)) {
                    const newNode = { name: method, value: 0, children: [] };
                    pathMap.set(newPath, newNode);
                    currentNode.children.push(newNode);
                }
                const child = pathMap.get(newPath);
                child.value += count;
                currentNode = child;
                currentPath = newPath;
            });
        });
        return root;
    }

    // --- è¾…åŠ©åŠŸèƒ½ ---
    async function resetData() {
        if(!confirm("ç¡®å®šæ¸…ç©ºæ‰€æœ‰å†å²æ•°æ®ï¼Ÿ")) return;
        await fetch('/api/v1/flamegraph/reset', { method: 'POST' });
        document.getElementById('chart').innerHTML = '';
        showNoData(true);
        updateStatus("æ•°æ®å·²æ¸…ç©º");
    }

    async function copyToClipboard() {
        if (!currentRawData) return alert("æš‚æ— æ•°æ®å¯å¤åˆ¶");
        try {
            await navigator.clipboard.writeText(currentRawData);
            const btn = document.getElementById('copyBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = "âœ… å·²å¤åˆ¶";
            setTimeout(() => btn.innerHTML = originalText, 2000);
        } catch (e) { alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶"); }
    }

    function setLoading(b) {
        document.getElementById('loading').style.display = b ? 'block' : 'none';
        document.getElementById('errorMsg').style.display = 'none';
        if(b) document.getElementById('noData').style.display = 'none';
    }
    function showNoData(b) {
        document.getElementById('noData').style.display = b ? 'block' : 'none';
        if(b) document.getElementById('chart').innerHTML = '';
    }
    function showError(msg) {
        document.getElementById('errorMsg').innerText = "âš ï¸ " + msg;
        document.getElementById('errorMsg').style.display = 'block';
        document.getElementById('loading').style.display = 'none';
    }
    function updateStatus(msg) { document.getElementById('statusBar').innerText = msg; }
</script>
</body>
</html>